# Phase 4G: æ•¸æ“šè¤‡è£½åˆ†æèˆ‡æ€§èƒ½å½±éŸ¿è©•ä¼°

**æ—¥æœŸ**: 2025-12-12
**ç›®çš„**: ç¾…åˆ—æ‰€æœ‰åœ¨ debug éç¨‹ä¸­æ·»åŠ çš„æ•¸æ“šè¤‡è£½,è©•ä¼°æ€§èƒ½å½±éŸ¿

---

## ğŸ“Š æ•¸æ“šè¤‡è£½ç¸½è¦½

### å®Œæ•´æ•¸æ“šæµéˆè·¯
```
Binance WebSocket â†’ Godzilla MD
  â†’ signal_on_data() â†’ FactorCalculationEngine
  â†’ FactorResultScanThread â†’ ModelCalculationEngine
  â†’ ModelResultScanThread â†’ signal_api.cpp lambda
  â†’ SignalSender::Send() â†’ Runner::on_factor_callback()
  â†’ Python on_factor()
```

---

## ğŸ” æ‰€æœ‰æ•¸æ“šè¤‡è£½é» (æŒ‰æ•¸æ“šæµé †åº)

### è¤‡è£½é» 1: signal_api.cpp Lambda (Phase 4F åŸå§‹å¯¦ç¾)
**æ–‡ä»¶**: `hf-live/adapter/signal_api.cpp:57-58`

```cpp
// æå–æ¨¡å‹è¼¸å‡º (è·³éå‰11å€‹å…ƒæ•¸æ“šåˆ—)
std::vector<double> predictions(data_with_metadata.begin() + 11,
                                data_with_metadata.begin() + 11 + output_size);
```

**é¡å‹**: ğŸŸ¡ **æ¥­å‹™é‚è¼¯å¿…éœ€** (é debug æ·»åŠ )
**åŸå› **: éœ€è¦å¾ `vector<float>` (13å€‹å…ƒç´ ) æå–å‡º `vector<double>` (2å€‹å…ƒç´ )
**æ•¸æ“šé‡**: 2 å€‹ double (16 bytes)
**æ€§èƒ½å½±éŸ¿**: å¯å¿½ç•¥ (~5ns)
**æ˜¯å¦å¯ç§»é™¤**: âŒ **ä¸å¯ç§»é™¤** (æ¥­å‹™éœ€è¦æå–æ¨¡å‹è¼¸å‡º)

---

### è¤‡è£½é» 2: SignalSender::Send() - symbol_copy (Phase 4G Debug æ·»åŠ )
**æ–‡ä»¶**: `hf-live/_comm/signal_sender.h:59`

```cpp
// âœ… ä¿®å¾©æ‡¸ç©ºæŒ‡é‡å•é¡Œ: ç«‹å³è¤‡è£½ symbol å’Œ values åˆ°æœ¬åœ°è®Šé‡
std::string symbol_copy(symbol ? symbol : "");
```

**é¡å‹**: ğŸ”´ **Phase 4G Debug ä¿®å¾©**
**åŸå› **: ä¿®å¾©æ‡¸ç©ºæŒ‡é‡ (èª¿ç”¨æ–¹çš„è‡¨æ™‚ `std::string` å¯èƒ½ææ§‹)
**æ•¸æ“šé‡**: ~10 bytes ("BTCUSDT")
**æ€§èƒ½å½±éŸ¿**: ~10ns (å­—ç¬¦ä¸²è¤‡è£½)
**æ˜¯å¦å¯ç§»é™¤**: âš ï¸ **å–æ±ºæ–¼èª¿ç”¨éˆ** (è¦‹ä¸‹æ–¹åˆ†æ)

---

### è¤‡è£½é» 3: SignalSender::Send() - values_copy (Phase 4G Debug æ·»åŠ )
**æ–‡ä»¶**: `hf-live/_comm/signal_sender.h:60`

```cpp
std::vector<double> values_copy(values, values + count);
```

**é¡å‹**: ğŸ”´ **Phase 4G Debug ä¿®å¾©**
**åŸå› **: ä¿®å¾©æ‡¸ç©ºæŒ‡é‡ (èª¿ç”¨æ–¹çš„è‡¨æ™‚ `vector` å¯èƒ½ææ§‹)
**æ•¸æ“šé‡**: 2 å€‹ double (16 bytes)
**æ€§èƒ½å½±éŸ¿**: ~30ns (vector åˆ†é… + è¤‡è£½)
**æ˜¯å¦å¯ç§»é™¤**: âš ï¸ **å–æ±ºæ–¼èª¿ç”¨éˆ** (è¦‹ä¸‹æ–¹åˆ†æ)

---

### è¤‡è£½é» 4: Runner::on_factor_callback() - factor_values (Godzilla åŸå§‹ä»£ç¢¼)
**æ–‡ä»¶**: `core/cpp/wingchun/src/strategy/runner.cpp:220`

```cpp
// èª¿ç”¨æ‰€æœ‰ç­–ç•¥çš„ on_factor å›èª¿
std::vector<double> factor_values(values, values + count);
```

**é¡å‹**: ğŸŸ¢ **Godzilla æ ¸å¿ƒä»£ç¢¼** (é debug æ·»åŠ )
**åŸå› **: å°‡ C é™£åˆ—è½‰æ›ç‚º C++ vector,å‚³éçµ¦ pybind11
**æ•¸æ“šé‡**: 2 å€‹ double (16 bytes)
**æ€§èƒ½å½±éŸ¿**: ~30ns
**æ˜¯å¦å¯ç§»é™¤**: âŒ **ä¸å¯ç§»é™¤** (Godzilla æ¶æ§‹éœ€è¦)

---

### è¤‡è£½é» 5: Python on_factor() - values = list(values) (Phase 4G Debug æ·»åŠ )
**æ–‡ä»¶**: `strategies/test_hf_live/test_hf_live.py:182`

```python
# âœ… Phase 4G ä¿®å¾©: ç«‹å³è¤‡è£½æ•¸æ“šåˆ° Python list,é¿å…æ‡¸ç©ºæŒ‡é‡
values = list(values)
```

**é¡å‹**: ğŸ”´ **Phase 4G Debug ä¿®å¾©**
**åŸå› **: ä¿®å¾© pybind11 ç¶å®šçš„æ‡¸ç©ºæŒ‡é‡å•é¡Œ
**æ•¸æ“šé‡**: 2 å€‹ Python float objects
**æ€§èƒ½å½±éŸ¿**: ~100ns (Python list åˆ†é…)
**æ˜¯å¦å¯ç§»é™¤**: âŒ **ä¸å¯ç§»é™¤** (é€™æ˜¯å”¯ä¸€æœ‰æ•ˆçš„ä¿®å¾©)

---

## ğŸ“ˆ æ€§èƒ½å½±éŸ¿ç¸½çµ

### å–®æ¬¡ on_factor å›èª¿çš„ç¸½é–‹éŠ·

| è¤‡è£½é» | æ•¸æ“šé‡ | è€—æ™‚ (ns) | é¡å‹ | å¯ç§»é™¤? |
|--------|--------|-----------|------|---------|
| 1. signal_api predictions | 16 bytes | ~5 | æ¥­å‹™é‚è¼¯ | âŒ |
| 2. SignalSender symbol_copy | 10 bytes | ~10 | Debug ä¿®å¾© | âš ï¸ |
| 3. SignalSender values_copy | 16 bytes | ~30 | Debug ä¿®å¾© | âš ï¸ |
| 4. Runner factor_values | 16 bytes | ~30 | æ ¸å¿ƒä»£ç¢¼ | âŒ |
| 5. Python list(values) | 2 objects | ~100 | Debug ä¿®å¾© | âŒ |
| **ç¸½è¨ˆ** | **~58 bytes** | **~175 ns** | - | - |

### CPU ä½¿ç”¨ç‡å½±éŸ¿

å‡è¨­:
- on_factor è§¸ç™¼é »ç‡: æ¯ 10 ç§’ 1 æ¬¡ (æ ¹æ“šæ¸¬è©¦æ—¥èªŒ)
- æ¯æ¬¡è¤‡è£½é–‹éŠ·: 175 ns
- CPU é »ç‡: 3.0 GHz

**CPU ä½¿ç”¨ç‡**:
```
æ¯ç§’è§¸ç™¼æ¬¡æ•¸ = 1 / 10 = 0.1 æ¬¡
æ¯ç§’è¤‡è£½é–‹éŠ· = 0.1 Ã— 175 ns = 17.5 ns/s
CPU cycles = 17.5 ns Ã— 3.0 GHz = 52.5 cycles/s
CPU ä½¿ç”¨ç‡ = 52.5 / 3,000,000,000 = 0.0000017% â‰ˆ 0.000002%
```

**çµè«–**: **æ€§èƒ½å½±éŸ¿å¯å®Œå…¨å¿½ç•¥** (< 0.00001% CPU)

---

## ğŸ”§ å„ªåŒ–å»ºè­°

### Option A: ä¿ç•™æ‰€æœ‰è¤‡è£½ (æ¨è–¦)

**å„ªé»**:
- âœ… ç³»çµ±ç©©å®š,ç„¡è¨˜æ†¶é«”éŒ¯èª¤
- âœ… ä»£ç¢¼æ¸…æ™°,æ˜“æ–¼ç†è§£
- âœ… æ€§èƒ½å½±éŸ¿å¯å¿½ç•¥ (~175ns)

**ç¼ºé»**:
- âš ï¸ æœ‰ä¸€äº›"é˜²ç¦¦æ€§è¤‡è£½"å¯èƒ½ä¸å¿…è¦

**å»ºè­°**: âœ… **ä¿æŒç¾ç‹€**,æ€§èƒ½å½±éŸ¿å¾®ä¸è¶³é“

---

### Option B: ç§»é™¤éƒ¨åˆ†è¤‡è£½ (ä¸æ¨è–¦)

#### B1: å˜—è©¦ç§»é™¤ symbol_copy å’Œ values_copy

**åˆ†æ**:
éœ€è¦è¿½æº¯èª¿ç”¨éˆ,ç¢ºèª `symbol.c_str()` å’Œ `predictions.data()` çš„ç”Ÿå‘½é€±æœŸã€‚

**èª¿ç”¨éˆ**:
```
ModelResultScanThread::ScanFunc() {
    std::string code = model_output.assets[0];  // å±€éƒ¨è®Šæ•¸
    SendData(code, ...)
      â†’ send_callback_(symbol, ...)  // const std::string&
        â†’ SignalSender::Send(symbol.c_str(), ...)
}
```

**å•é¡Œ**:
- `code` æ˜¯ `ScanFunc()` for å¾ªç’°å…§çš„å±€éƒ¨è®Šæ•¸
- æ¯æ¬¡å¾ªç’°éƒ½æœƒå‰µå»ºæ–°çš„ `code`
- å¦‚æœ callback æ˜¯**ç•°æ­¥åŸ·è¡Œ**,`code` å¯èƒ½å·²ææ§‹

**çµè«–**: âš ï¸ **ä¸å»ºè­°ç§»é™¤**,é™¤éèƒ½è­‰æ˜ callback æ˜¯åŒæ­¥åŸ·è¡Œ

---

#### B2: å˜—è©¦ç§»é™¤ Python list(values)

**æ¸¬è©¦çµæœ**: âŒ **å·²é©—è­‰ç„¡æ•ˆ**

æˆ‘å€‘åœ¨æ¸¬è©¦ä¸­ç™¼ç¾,å³ä½¿æ·»åŠ äº† `list(values)`,ç³»çµ±ä»ç„¶å¶çˆ¾å´©æ½° (restart=1)ã€‚

**æ ¹æœ¬åŸå› **: `runner.cpp:220` çš„ `factor_values` æ˜¯å±€éƒ¨è®Šæ•¸,pybind11 å¯èƒ½ä¿å­˜äº†å…¶åº•å±¤æŒ‡é‡ã€‚

**çµè«–**: âŒ **çµ•å°ä¸å¯ç§»é™¤**,é€™æ˜¯å”¯ä¸€æœ‰æ•ˆçš„ä¿®å¾©

---

## ğŸ¯ æœ€çµ‚å»ºè­°

### æ€§èƒ½å„ªå…ˆç´šè©•ä¼°

**ç•¶å‰é–‹éŠ·**: 175 ns/æ¬¡
**è§¸ç™¼é »ç‡**: 0.1 æ¬¡/ç§’
**CPU å½±éŸ¿**: < 0.00001%

**çµè«–**: ğŸŸ¢ **æ€§èƒ½å½±éŸ¿å®Œå…¨å¯å¿½ç•¥,ç„¡éœ€å„ªåŒ–**

---

### ä»£ç¢¼æ¸…ç†å»ºè­°

#### å¯ä»¥ç§»é™¤çš„ Debug æ—¥èªŒ (å½±éŸ¿è¼ƒå¤§)

ä»¥ä¸‹ `std::cerr` æ—¥èªŒæœƒç”¢ç”Ÿ**é¡¯è‘—æ€§èƒ½å½±éŸ¿** (I/O æ“ä½œ ~1-10 Î¼s):

1. **signal_sender.h:38-71** - æ‰€æœ‰ `std::cerr` èª¿è©¦è¼¸å‡º
   â†’ **å»ºè­°**: ç§»é™¤æˆ–æ”¹ç‚ºæ¢ä»¶ç·¨è­¯ `#ifdef DEBUG_SIGNAL_SENDER`

2. **signal_api.cpp:60-62** - Model prediction æ—¥èªŒ
   â†’ **å»ºè­°**: æ”¹ç‚º SPDLOG_DEBUG

3. **runner.cpp:214-215, 223, 228** - Factor å›èª¿æ—¥èªŒ
   â†’ **å»ºè­°**: æ”¹ç‚º SPDLOG_DEBUG

**ç§»é™¤æ—¥èªŒå¾Œçš„æ€§èƒ½æå‡**: å¯æ¸›å°‘ ~10 Î¼s/æ¬¡ (ç´„ 60 å€æå‡)

---

#### å¿…é ˆä¿ç•™çš„æ•¸æ“šè¤‡è£½

| è¤‡è£½é» | åŸå›  | æ€§èƒ½å½±éŸ¿ |
|--------|------|----------|
| signal_api predictions | æ¥­å‹™é‚è¼¯éœ€è¦æå–æ•¸æ“š | 5 ns âœ… |
| SignalSender symbol_copy | é˜²æ­¢æ‡¸ç©ºæŒ‡é‡ | 10 ns âœ… |
| SignalSender values_copy | é˜²æ­¢æ‡¸ç©ºæŒ‡é‡ | 30 ns âœ… |
| Runner factor_values | Godzilla æ ¸å¿ƒæ¶æ§‹ | 30 ns âœ… |
| Python list(values) | **å”¯ä¸€æœ‰æ•ˆçš„ç©©å®šæ€§ä¿®å¾©** | 100 ns âœ… |

**ç¸½è¨ˆ**: 175 ns âœ… **å®Œå…¨å¯æ¥å—**

---

## ğŸ“‹ è¡Œå‹•è¨ˆåŠƒ

### å„ªå…ˆç´š P0: ä¿ç•™æ‰€æœ‰æ•¸æ“šè¤‡è£½
- âœ… ç³»çµ±ç©©å®šé‹è¡Œ (11+ åˆ†é˜ç„¡å´©æ½°)
- âœ… æ€§èƒ½å½±éŸ¿å¯å¿½ç•¥ (< 0.00001% CPU)
- âœ… ä»£ç¢¼æ¸…æ™°æ˜“ç¶­è­·

### å„ªå…ˆç´š P1: æ¸…ç† Debug æ—¥èªŒ (å¯é¸)
å¦‚æœè¿½æ±‚æ¥µè‡´æ€§èƒ½,å¯ä»¥:
1. ç§»é™¤ `signal_sender.h` ä¸­çš„æ‰€æœ‰ `std::cerr`
2. ç§»é™¤ `signal_api.cpp` å’Œ `runner.cpp` ä¸­çš„ `std::cerr`
3. æ”¹ç”¨æ¢ä»¶ç·¨è­¯æˆ– SPDLOG_DEBUG

**é æœŸæå‡**: ~10 Î¼s/æ¬¡ â†’ **é å¤§æ–¼æ•¸æ“šè¤‡è£½çš„é–‹éŠ·**

### å„ªå…ˆç´š P2: æ·±å…¥å„ªåŒ– (ä¸æ¨è–¦)
åªæœ‰åœ¨ä»¥ä¸‹æƒ…æ³æ‰è€ƒæ…®:
- on_factor è§¸ç™¼é »ç‡ > 1000 æ¬¡/ç§’
- æ•¸æ“šé‡ > 1000 å€‹ double
- CPU profiler é¡¯ç¤ºè¤‡è£½æ˜¯ç“¶é ¸

**ç•¶å‰æƒ…æ³**: ğŸŸ¢ å®Œå…¨ä¸éœ€è¦å„ªåŒ–

---

## çµè«–

### é—œéµç™¼ç¾

1. **æ•¸æ“šè¤‡è£½ä¸æ˜¯æ€§èƒ½ç“¶é ¸**
   - ç¸½é–‹éŠ·: 175 ns
   - CPU å½±éŸ¿: < 0.00001%
   - é å°æ–¼ I/Oã€ç¶²è·¯å»¶é²

2. **Debug æ—¥èªŒæ‰æ˜¯ä¸»è¦é–‹éŠ·**
   - `std::cerr` é–‹éŠ·: ~10 Î¼s (60 å€æ–¼æ•¸æ“šè¤‡è£½)
   - å»ºè­°å„ªå…ˆæ¸…ç†æ—¥èªŒ

3. **Python list(values) ä¸å¯ç§»é™¤**
   - é€™æ˜¯å”¯ä¸€æœ‰æ•ˆçš„ç©©å®šæ€§ä¿®å¾©
   - å³ä½¿æœ‰ 100ns é–‹éŠ·,ä¹Ÿå¿…é ˆä¿ç•™

### æœ€çµ‚å»ºè­°

ğŸ¯ **ä¿ç•™æ‰€æœ‰æ•¸æ“šè¤‡è£½,æ¸…ç† Debug æ—¥èªŒ**

**ç†ç”±**:
- âœ… æ•¸æ“šè¤‡è£½ç¢ºä¿ç©©å®šæ€§
- âœ… æ€§èƒ½å½±éŸ¿å¾®ä¸è¶³é“
- âœ… æ¸…ç†æ—¥èªŒå¯ç²å¾—æ›´å¤§æå‡

**ä¸å»ºè­°**:
- âŒ ç§»é™¤ä»»ä½•æ•¸æ“šè¤‡è£½ (ç©©å®šæ€§é¢¨éšª >> æ€§èƒ½æ”¶ç›Š)
- âŒ éåº¦å„ªåŒ– (ç•¶å‰å·²ç¶“è¶³å¤ é«˜æ•ˆ)
