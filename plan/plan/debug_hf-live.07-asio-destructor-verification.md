# ASIO ææ§‹å‡½æ•¸å•é¡Œé©—è­‰èˆ‡ä¿®å¾©è¨ˆåŠƒ

**å‰µå»ºæ—¥æœŸ**: 2025-12-23
**ç‹€æ…‹**: Phase 1 - å•é¡Œé©—è­‰ä¸­
**å„ªå…ˆç´š**: ğŸ”´ é«˜

---

## ğŸ“‹ åŸ·è¡Œæ‘˜è¦

### å•é¡Œæè¿°
åŸ AI è¨ºæ–·å ±å‘ŠæŒ‡å‡º `MarketDataBinance::~MarketDataBinance() {}` ç©ºææ§‹å‡½æ•¸é•å RAII åŸå‰‡,å¯èƒ½å°è‡´ bus errorã€‚

### å¯©æŸ¥çµè«– (åŸºæ–¼ 6 å€‹ä¸¦è¡Œ agents èª¿æŸ¥)

| ç¶­åº¦ | è©•åˆ† | çµè«– |
|------|------|------|
| æŠ€è¡“æ­£ç¢ºæ€§ | 10/10 | âœ… ASIO ææ§‹è¨ºæ–· 100% æ­£ç¢º |
| å¯¦éš›å½±éŸ¿ | 6/10 | âš ï¸ Phase 6 RELEASE æ¨¡å¼æ¸¬è©¦æˆåŠŸ,å­˜åœ¨çŸ›ç›¾ |
| å´©æ½°è­‰æ“š | 7/10 | âš ï¸ æœ‰ bus error ä½†è§¸ç™¼é»åœ¨ _check_status(),éææ§‹ |
| æ™‚é–“ç·šä¸€è‡´æ€§ | 4/10 | ğŸ”´ é‡å¤§çŸ›ç›¾:æ¸¬è©¦é€šé vs ç”¨æˆ¶å ±å‘Šå•é¡Œ |
| ä¿®å¾©å¿…è¦æ€§ | 9/10 | âœ… å³ä½¿æœªå´©æ½°,ä¹Ÿæ‡‰è©²ä¿®å¾© RAII é•è¦ |

**ç¸½é«”è©•åˆ†**: 7.2/10 - æŠ€è¡“æ­£ç¢ºä½†å¯¦éš›å½±éŸ¿å­˜ç–‘

### ç”¨æˆ¶ç¢ºèª
1. âœ… å•é¡Œåœ¨ç•¶å‰ commit çš„ RELEASE ç‹€æ…‹ä¸‹å‡ºç¾
2. âš ï¸ Bus error èˆ‡ ASIO ææ§‹çš„é—œä¿‚æœªçŸ¥
3. ğŸ¯ ç­–ç•¥: **å…ˆé©—è­‰å•é¡Œå†ä¿®å¾©**
4. ğŸ“‹ æ–¹æ³•: æ¸…ç©º log,é‡å•Ÿæœå‹™æ¸¬è©¦,åŠ å…¥è¨ºæ–·æ—¥èªŒ

---

## ğŸ” æŠ€è¡“åˆ†æç¸½çµ

### Agent èª¿æŸ¥ç™¼ç¾

#### Agent 1: Git History (æ­·å²è­‰æ“š)
- âœ… ç™¼ç¾å¤§é‡æ­·å²æ–‡æª”è¨˜éŒ„ MD Gateway å’Œ hf-live å´©æ½°å•é¡Œ
- âœ… Phase 4C-4H ä¿®å¾©äº†å¤šå€‹å…§å­˜å•é¡Œ (double-free, atomic, æ‡¸ç©ºæŒ‡é‡)
- âœ… ç©ºææ§‹å¾ v2.1.0 å°±å­˜åœ¨ (upstream bug)

#### Agent 2: Code Pattern (ä»£ç¢¼æ¨¡å¼)
- âœ… ç¢ºèªå…©å€‹ç©ºææ§‹: `MarketDataBinance` å’Œ `TraderBinance`
- âœ… å°æ¯”å…¶ä»–çµ„ä»¶æœ‰æ­£ç¢ºå¯¦ç¾ (`FactorCalculationThread`, `websockets::impl`)
- âœ… `shared_ptr<thread>` ä¸æœƒè‡ªå‹• join,æœƒè§¸ç™¼ `std::terminate()`

#### Agent 3: Build Config (ç·¨è­¯é…ç½®)
- âœ… åªæœ‰ DEBUG_MODE æ”¹è®Š (ON â†’ OFF)
- âœ… ç„¡å…¶ä»–ç·¨è­¯é¸é …æˆ–ä¾è³´ç‰ˆæœ¬è®Šæ›´
- âœ… å®Œå…¨æ”¯æŒ AI çš„ DEBUG/RELEASE è¨ºæ–·æ–¹å‘

#### Agent 4: ASIO Expert (æŠ€è¡“æ¬Šå¨)
- âœ… `io_context::run()` å¿…é ˆé¡¯å¼èª¿ç”¨ `stop()` æ‰æœƒè¿”å›
- âœ… æ²’æœ‰è‡ªå‹•æ¸…ç†æ©Ÿåˆ¶
- âœ… æä¾›æ¨™æº– ASIO ææ§‹å¯¦ç¾æ–¹æ¡ˆ

#### Agent 5: Forensics (å´©æ½°å–è­‰)
- âš ï¸ æ‰¾åˆ° 4 å€‹ MD Gateway bus error (2024-12-22)
- âš ï¸ æ‰¾åˆ° 22 å€‹ TD Gateway bus error (2024-12-17~22)
- âš ï¸ ä½†è§¸ç™¼é»åœ¨ `_check_status()` WebSocket é‡é€£,éææ§‹å‡½æ•¸

#### Agent 6: Contradiction Hunter (çŸ›ç›¾åˆ†æ)
- ğŸ”´ ç™¼ç¾é‡å¤§çŸ›ç›¾:Phase 6 åœ¨ RELEASE æ¨¡å¼ä¸‹æˆåŠŸé‹è¡Œ 60+ åˆ†é˜,0 æ¬¡é‡å•Ÿ
- ğŸ”´ æ¸¬è©¦å ±å‘Šé¡¯ç¤ºç³»çµ±æ­£å¸¸,ä½†ç”¨æˆ¶å ±å‘Šæœ‰å•é¡Œ
- ğŸ”´ æ™‚é–“ç·šä¸ä¸€è‡´,éœ€è¦é‡ç¾å•é¡Œç¢ºèªæ ¹å› 

---

## ğŸ¯ åŸ·è¡Œè¨ˆåŠƒ

### Phase 1: å•é¡Œé‡ç¾èˆ‡è­‰æ“šæ”¶é›† â¬œ (ç•¶å‰éšæ®µ)

**ç›®æ¨™**: ç¢ºèª ASIO ææ§‹å•é¡Œæ˜¯å¦çœŸå¯¦è§¸ç™¼

**æ­¥é©Ÿ**:
1. âœ… å‚™ä»½ç•¶å‰æ—¥èªŒ
2. âœ… æ¸…ç©º PM2 æ—¥èªŒ
3. âœ… é‡å•Ÿ MD Gateway
4. â¬œ è§€å¯Ÿæ­£å¸¸é‹è¡Œ (15-30 åˆ†é˜)
5. â¬œ æ¸¬è©¦æœå‹™åœæ­¢å ´æ™¯
   - pm2 stop (æ­£å¸¸åœæ­¢)
   - pm2 restart + stop (SIGTERM)
   - å®Œæ•´é‡å•Ÿå¾ªç’°

**é—œéµæª¢æŸ¥é»**:
- æ˜¯å¦åœ¨æœå‹™åœæ­¢æ™‚å‡ºç¾ bus error?
- æ˜¯å¦çœ‹åˆ° "pure virtual method called"?
- ææ§‹å‡½æ•¸æ˜¯å¦è¢«èª¿ç”¨?

---

### Phase 2: æ·»åŠ è¨ºæ–·æ—¥èªŒ â¬œ

**è§¸ç™¼æ¢ä»¶**: Phase 1 ç„¡æ³•é‡ç¾å•é¡Œ

**ç›®æ¨™**: åœ¨é—œéµä½ç½®æ·»åŠ æ—¥èªŒä¾†è¿½è¹¤å•é¡Œ

**ä¿®æ”¹æ–‡ä»¶**:
1. `core/extensions/binance/src/marketdata_binance.cpp:58` (ææ§‹å‡½æ•¸)
2. `core/extensions/binance/src/marketdata_binance.cpp:373-408` (_check_status)

**æ—¥èªŒç­–ç•¥**:
- ğŸ”´ ç´…è‰²æ¨™è¨˜: ææ§‹å‡½æ•¸é—œéµé»
- ğŸ”µ è—è‰²æ¨™è¨˜: _check_status æ­£å¸¸æµç¨‹
- ğŸŸ¡ é»ƒè‰²æ¨™è¨˜: ç•°å¸¸æˆ–è­¦å‘Š

**é‡æ–°ç·¨è­¯ä¸¦æ¸¬è©¦**:
```bash
cd /app/core && mkdir -p build && cd build && cmake .. && make -j4
```

---

### Phase 3: æ ¹æ“šè­‰æ“šæ±ºå®šä¿®å¾©æ–¹æ¡ˆ â¬œ

#### æƒ…å¢ƒ A: ç¢ºèªæ˜¯ææ§‹å‡½æ•¸å•é¡Œ
**è­‰æ“š**: "ğŸ”´ [DESTRUCTOR] task_thread_ exists, joinable=true" å¾Œå´©æ½°

**ä¿®å¾©**: å¯¦æ–½å®Œæ•´ ASIO ææ§‹é‚è¼¯
```cpp
MarketDataBinance::~MarketDataBinance() {
    SPDLOG_INFO("MarketDataBinance destructor: stopping ASIO");
    ioctx_.stop();
    if (task_thread_ && task_thread_->joinable()) {
        task_thread_->join();
    }
    ws_ptr_.reset();
    fws_ptr_.reset();
    dws_ptr_.reset();
    rest_ptr_.reset();
    frest_ptr_.reset();
    SPDLOG_INFO("MarketDataBinance destructor: complete");
}
```

**åŒæ™‚ä¿®å¾©**: `trader_binance.cpp:83`

#### æƒ…å¢ƒ B: ç¢ºèªæ˜¯ _check_status å•é¡Œ
**è­‰æ“š**: "ğŸ”´ [CHECK_STATUS] Exception" åœ¨ bus error ä¹‹å‰

**ä¿®å¾©**: åŠ å¼·ç•°å¸¸è™•ç†
```cpp
void MarketDataBinance::_check_status(kungfu::yijinjing::event_ptr) {
    try {
        // ç¾æœ‰é‚è¼¯
    } catch (const std::exception& e) {
        SPDLOG_ERROR("_check_status exception: {}", e.what());
        return;  // ä¸è¦ throw
    } catch (...) {
        SPDLOG_ERROR("_check_status unknown exception");
        return;
    }
}
```

#### æƒ…å¢ƒ C: å…©å€‹å•é¡Œéƒ½å­˜åœ¨
**ä¿®å¾©**: åŒæ™‚ä¿®å¾© A å’Œ B

#### æƒ…å¢ƒ D: ç„¡æ³•é‡ç¾å•é¡Œ
**ä¿®å¾©**:
1. ä¿ç•™è¨ºæ–·æ—¥èªŒ
2. å¯¦æ–½é é˜²æ€§ææ§‹å‡½æ•¸ä¿®å¾©
3. é•·æœŸè§€å¯Ÿ

---

### Phase 4: é•·æœŸé©—è­‰ â¬œ

**é©—è­‰é …ç›®**:
- [ ] RELEASE æ¨¡å¼é‹è¡Œ 24 å°æ™‚
- [ ] ç„¡ bus error å‡ºç¾
- [ ] PM2 restart count = 0
- [ ] å¸‚å ´æ•¸æ“šæ­£å¸¸æµå…¥
- [ ] Factor è¨ˆç®—æ­£å¸¸

---

## ğŸ“Š ç›¸é—œæ–‡ä»¶

### å•é¡Œè¨ºæ–·æ–‡æª”
- `plan/md-gateway-asio-destructor-fix.md` - åŸ AI è¨ºæ–·å ±å‘Š
- `plan/plan/debug_hf-live.00-complete-e2e-debug.md` - Phase 4 å…§å­˜å•é¡Œèª¿è©¦
- `plan/plan/debug_hf-live.02-spmc-buffer-data-race.md` - è·¨ç·šç¨‹å›èª¿ç«¶æ…‹

### æ ¸å¿ƒä»£ç¢¼æ–‡ä»¶
- `core/extensions/binance/src/marketdata_binance.cpp:58` - MD Gateway ææ§‹å‡½æ•¸
- `core/extensions/binance/src/trader_binance.cpp:83` - TD Gateway ææ§‹å‡½æ•¸
- `core/extensions/binance/src/marketdata_binance.cpp:373-408` - _check_status æ–¹æ³•

### åƒè€ƒå¯¦ç¾
- `hf-live/app_live/thread/factor_calculation_thread.h` - æ­£ç¢ºçš„ç·šç¨‹ç®¡ç†
- `core/extensions/binance/src/binapi/websocket.cpp:280` - æ­£ç¢ºçš„è³‡æºæ¸…ç†

---

## âš ï¸ é¢¨éšªè©•ä¼°

| é¢¨éšª | å¯èƒ½æ€§ | å½±éŸ¿ | ç·©è§£æªæ–½ |
|------|-------|------|---------|
| æ·»åŠ æ—¥èªŒå°è‡´æ€§èƒ½ä¸‹é™ | ä½ | ä½ | ä½¿ç”¨ CRITICAL/ERROR ç­‰ç´š |
| é‡æ–°ç·¨è­¯å°è‡´å…¶ä»–å•é¡Œ | ä½ | ä¸­ | å®Œæ•´å›æ­¸æ¸¬è©¦ |
| ææ§‹ä¿®å¾©å¼•å…¥æ–° bug | æ¥µä½ | ä¸­ | æ¨™æº– ASIO å¯¦è¸ |
| ç„¡æ³•é‡ç¾å•é¡Œ | ä¸­ | ä½ | é•·æœŸè§€å¯Ÿ |
| ä¿®å¾©å¾Œä»æœ‰å…¶ä»–å´©æ½° | ä¸­ | é«˜ | é€æ­¥ä¿®å¾© |

---

## ğŸ“ˆ é€²åº¦è¿½è¹¤

### ç•¶å‰ç‹€æ…‹
- **Phase**: 1 (å•é¡Œé‡ç¾èˆ‡è­‰æ“šæ”¶é›†)
- **é€²åº¦**: 0% â†’ æº–å‚™é–‹å§‹
- **è² è²¬äºº**: AI Agent (å¤š agent ä¸¦è¡ŒåŸ·è¡Œ)
- **é è¨ˆæ™‚é–“**: 1-2 å°æ™‚

### æª¢æŸ¥æ¸…å–®

#### Phase 1: é‡ç¾å•é¡Œ
- [ ] å‚™ä»½ç•¶å‰æ—¥èªŒ
- [ ] æ¸…ç©ºæ—¥èªŒå’Œ PM2 logs
- [ ] é‡å•Ÿæœå‹™ä¸¦è§€å¯Ÿ (15-30 åˆ†é˜)
- [ ] æ¸¬è©¦æ­£å¸¸åœæ­¢
- [ ] æ¸¬è©¦ SIGTERM
- [ ] æ¸¬è©¦å®Œæ•´é‡å•Ÿå¾ªç’°
- [ ] è¨˜éŒ„æ‰€æœ‰è§€å¯Ÿçµæœ

#### Phase 2: è¨ºæ–·æ—¥èªŒ
- [ ] åœ¨ææ§‹å‡½æ•¸æ·»åŠ æ—¥èªŒ
- [ ] åœ¨ _check_status æ·»åŠ æ—¥èªŒ
- [ ] é‡æ–°ç·¨è­¯
- [ ] é‡å•Ÿä¸¦æ¸¬è©¦
- [ ] åˆ†ææ—¥èªŒè¼¸å‡º

#### Phase 3: å¯¦æ–½ä¿®å¾©
- [ ] æ ¹æ“šè­‰æ“šé¸æ“‡æ–¹æ¡ˆ
- [ ] ä¿®æ”¹ marketdata_binance.cpp
- [ ] ä¿®æ”¹ trader_binance.cpp (å¦‚éœ€)
- [ ] é‡æ–°ç·¨è­¯
- [ ] æ¸¬è©¦ä¿®å¾©æ•ˆæœ
- [ ] é©—è­‰ç„¡å›æ­¸

#### Phase 4: é•·æœŸé©—è­‰
- [ ] 24 å°æ™‚é‹è¡Œ
- [ ] æª¢æŸ¥ç„¡ bus error
- [ ] æª¢æŸ¥ PM2 restart = 0
- [ ] ç¢ºèªæ•¸æ“šæ­£å¸¸
- [ ] è¨˜éŒ„æœ€çµ‚çµæœ

---

## ğŸ“ å­¸ç¿’ç¸½çµ

### å¤š Agent å¯©æŸ¥åƒ¹å€¼
é€™æ¬¡å¯©æŸ¥å±•ç¤ºäº†**æ‰¹åˆ¤æ€§æ€è€ƒ**çš„é‡è¦æ€§:
- Agent 1-4: æŠ€è¡“åˆ†ææ­£ç¢º,æ”¯æŒç«‹å³ä¿®å¾©
- Agent 5-6: ç™¼ç¾çŸ›ç›¾è­‰æ“š,ä¿ƒä½¿å…ˆé©—è­‰å†ä¿®å¾©

### é—œéµæ•™è¨“
1. âœ… æŠ€è¡“æ­£ç¢º â‰  è¨ºæ–·æ­£ç¢º
2. âœ… æ™‚é–“ç·šä¸€è‡´æ€§æ˜¯é—œéµ
3. âœ… ç”¨æˆ¶å›é¥‹å„ªå…ˆæ–¼ç†è«–åˆ†æ
4. âœ… é«˜é¢¨éšªç³»çµ±éœ€è¦é©—è­‰è€Œéå¿«é€Ÿè¡Œå‹•
5. âœ… é é˜²æ€§ä¿®å¾© vs ç·Šæ€¥ä¿®å¾©è¦å€åˆ†

---

## ğŸ“ è¯çµ¡è³‡è¨Š

- **å ±å‘Šå•é¡Œ**: æ›´æ–°æ­¤æ–‡æª”ä¸¦æäº¤ git commit
- **æŸ¥çœ‹æ—¥èªŒ**: `/home/huyifan/projects/godzilla-evan/runtime/md/binance/binance/log/live/`
- **PM2 ç®¡ç†**: `docker exec godzilla-dev pm2 list/logs/stop/restart`
- **å¯©æŸ¥è¨ˆåŠƒ**: `/home/huyifan/.claude/plans/sunny-toasting-comet.md`

---

## ğŸ¯ æ ¹æœ¬åŸå› å‡è¨­ (2025-12-23 14:15)

### æ‰¹åˆ¤æ€§çªç ´: "ç‚ºä»€éº¼ä»¥å‰æ²’å•é¡Œ?"

ç”¨æˆ¶é—œéµæŒ‡ä»¤: **"be suspicious ç‚ºç”šéº¼ä»¥å‰æ²’æœ‰å‡ºç¾éé€™å€‹å•é¡Œ æ˜¯æ‰¾åˆ°å•é¡Œè§£æ³•çš„é—œéµ"**

### èª¿æŸ¥çµæœ

#### âœ… Phase 1-3 åŸ·è¡Œç‹€æ…‹

1. **Phase 1: å•é¡Œé‡ç¾** âœ… å®Œæˆ
   - 3/3 æ¸¬è©¦é‡å•Ÿè§¸ç™¼ bus error
   - ç¢ºèª ASIO ææ§‹å•é¡ŒçœŸå¯¦å­˜åœ¨

2. **Phase 2: ASIO ä¿®å¾©** âœ… å®Œæˆ
   - å¯¦æ–½å®Œæ•´ææ§‹é‚è¼¯ (both MD & TD)
   - é‡æ–°ç·¨è­¯ä¸¦éƒ¨ç½²

3. **Phase 3: é©—è­‰ä¿®å¾©** âœ… å®Œæˆ
   - Bus error å®Œå…¨æ¶ˆå¤± (0/5+ é‡å•Ÿ)
   - **ä½† connections: 0 ä»ç„¶å­˜åœ¨** âš ï¸

### æ ¸å¿ƒç™¼ç¾: å…©å€‹ç¨ç«‹å•é¡Œ

#### å•é¡Œ A: ASIO ææ§‹ bug (æ¬¡è¦,å·²ä¿®å¾© âœ…)
- **ç—‡ç‹€**: æœå‹™**åœæ­¢æ™‚** bus error
- **åŸå› **: ç©ºææ§‹å‡½æ•¸,ç·šç¨‹æœª join
- **ç‹€æ…‹**: å·²ä¿®å¾©,é‡å•Ÿä¸å†å´©æ½°

#### å•é¡Œ B: connections: 0 (ä¸»è¦,å¾…ä¿®å¾© ğŸ”´)
- **ç—‡ç‹€**: æœå‹™**å•Ÿå‹•æ™‚**ç­–ç•¥å´©æ½°,è¨‚é–±æœªåˆ°é” MD Gateway
- **æ ¹å› **: **Commit 7a4cc99 (2025-12-20) å¼•å…¥çš„å›æ­¸ bug**
- **é—œéµç·šç´¢**: æ‰¹åˆ¤æ€§æ€è€ƒ "ç‚ºä»€éº¼ä»¥å‰æ²’å•é¡Œ" æŒ‡å‘æœ€è¿‘ä»£ç¢¼è®Šæ›´

### Commit 7a4cc99 åˆ†æ

#### è®Šæ›´å…§å®¹
**Commit**: `feat(strategy): improve market data subscription and add verification callbacks`
**æ—¥æœŸ**: 2025-12-20
**æ–‡ä»¶**: `strategies/test_hf_live/test_hf_live.py`

#### ä»£ç¢¼å°æ¯”

**èˆŠä»£ç¢¼ (12/17 å‰,æ­£å¸¸é‹è¡Œ)**:
```python
def pre_start(context):
    # åªæœ‰ä¸€å€‹è¨‚é–±
    context.subscribe(md_source, [symbol], InstrumentType.FFuture, Exchange.BINANCE)
    context.log().info(f"ğŸ“¡ Subscribed: {symbol} (Futures) - All Market Data")
```

**æ–°ä»£ç¢¼ (12/20 å¾Œ,å´©æ½°)**:
```python
def pre_start(context):
    # ä¸‰å€‹è¨‚é–± + æ–°å›èª¿
    context.subscribe(md_source, [symbol], InstrumentType.FFuture, Exchange.BINANCE)
    context.subscribe_trade(md_source, [symbol], InstrumentType.FFuture, Exchange.BINANCE)
    context.subscribe_ticker(md_source, [symbol], InstrumentType.FFuture, Exchange.BINANCE)

# æ–°å¢å›èª¿ (Line 286+)
def on_trade(context, trade):
    context.log().info(f"ğŸ”¥ [TRADE] {trade.symbol} price={trade.price:.2f}")

def on_ticker(context, ticker):
    context.log().info(f"ğŸ“Š [TICKER] {ticker.symbol} bid={ticker.bid_price:.2f}")
```

#### MD Gateway ä»£ç¢¼é©—è­‰

æª¢æŸ¥ `core/extensions/binance/src/marketdata_binance.cpp` (Line 145-361):
- âœ… `subscribe()`: ä½¿ç”¨ `get_symbol_id(symbol, "depth", ...)`
- âœ… `subscribe_trade()`: ä½¿ç”¨ `get_symbol_id(symbol, "trade", ...)`
- âœ… `subscribe_ticker()`: ä½¿ç”¨ `get_symbol_id(symbol, "ticker", ...)`
- âœ… é‡è¤‡è¨‚é–±æœƒè¢«å®‰å…¨è·³é (`if (it != channel_cache_.end() and it->second.ready)`)

**çµè«–**: C++ å±¤è¨­è¨ˆæ­£ç¢º,ç†è«–ä¸Šæ”¯æŒå¤šè¨‚é–±

### å¯èƒ½çš„å´©æ½°é»

æ—¢ç„¶ C++ å±¤æ²’å•é¡Œ,é‚£éº¼å•é¡Œå¯èƒ½åœ¨:

1. **Python-C++ ç¶å®šå±¤**
   - pybind11 æˆ– Wingchun Python wrapper
   - é€£çºŒä¸‰æ¬¡å¿«é€Ÿèª¿ç”¨å¯èƒ½è§¸ç™¼ GIL ç›¸é—œç«¶æ…‹

2. **å›èª¿è¨»å†Šè¡çª**
   - æ–°å¢çš„ `on_trade()`, `on_ticker()` å›èª¿
   - å¯èƒ½åœ¨ pre_start() éšæ®µè¢«æå‰è§¸ç™¼
   - æˆ–å›èª¿è¨»å†Šè¡¨æœ‰ bug

3. **æ™‚åºå•é¡Œ**
   - ä¸‰å€‹è¨‚é–±å¤ªå¿«é€£çºŒèª¿ç”¨
   - MD Gateway ASIO åˆå§‹åŒ–å°šæœªå®Œæˆ

4. **æ—¥èªŒç³»çµ±ä¸ç©©å®š**
   - pre_start() éšæ®µå¤§é‡æ—¥èªŒèª¿ç”¨
   - å¯èƒ½åœ¨ç­–ç•¥åˆå§‹åŒ–éšæ®µä¸ç©©å®š

### é©—è­‰è¨ˆåŠƒ

#### Phase 4: å›æ»¾æ¸¬è©¦ (5åˆ†é˜é©—è­‰)

**æ¸¬è©¦ 4.1: å–®ä¸€è¨‚é–±** (æœ€å°è®Šæ›´)
```python
def pre_start(context):
    # å›æ»¾åˆ°å–®ä¸€è¨‚é–±
    context.subscribe(md_source, [symbol], InstrumentType.FFuture, Exchange.BINANCE)
    context.log().info(f"ğŸ“¡ Subscribed: {symbol} (Futures) - Depth only")
```
- âœ… å¦‚æœæ¢å¾© â†’ ç¢ºèªæ˜¯å¤šè¨‚é–±å¼•èµ·
- âŒ å¦‚æœä»å¤±æ•— â†’ æª¢æŸ¥å…¶ä»– commits (ee8a7ca, 1da1e97)

**æ¸¬è©¦ 4.2: æ¼¸é€²æ·»åŠ è¨‚é–±** (å¦‚æœ 4.1 æˆåŠŸ)
- æ¸¬è©¦ Depth + Trade
- æ¸¬è©¦ Depth + Ticker
- æ¸¬è©¦å…¨éƒ¨ä¸‰å€‹

**æ¸¬è©¦ 4.3: éš”é›¢å›èª¿** (å¦‚æœ 4.2 å…¨éƒ¨å¤±æ•—)
- ä¿ç•™ä¸‰å€‹è¨‚é–±
- è¨»è§£æ‰ `on_trade()`, `on_ticker()` å›èª¿

#### Phase 5: æ ¹æ“šçµæœä¿®å¾©

**æƒ…å¢ƒ A**: å–®ä¸€è¨‚é–±æ¢å¾©
- èªªæ˜å¤šè¨‚é–±ç¢ºå¯¦æœ‰å•é¡Œ
- éœ€è¦æª¢æŸ¥ Python wrapper æˆ–æ·»åŠ  delay

**æƒ…å¢ƒ B**: Depth + Trade æˆåŠŸ,Depth + Ticker å¤±æ•—
- èªªæ˜ `subscribe_ticker()` æœ‰ç‰¹æ®Šå•é¡Œ
- éœ€è¦æª¢æŸ¥ ticker è¨‚é–±é‚è¼¯

**æƒ…å¢ƒ C**: ä¸‰å€‹è¨‚é–±æˆåŠŸ,ä½†è¨»è§£å›èª¿å¾Œæ‰æˆåŠŸ
- èªªæ˜å›èª¿è¨»å†Šæœ‰å•é¡Œ
- éœ€è¦æª¢æŸ¥å›èª¿è¨»å†Šæ™‚æ©Ÿ

**æƒ…å¢ƒ D**: å–®ä¸€è¨‚é–±ä»å¤±æ•—
- å•é¡Œä¸åœ¨è¨‚é–±æ•¸é‡
- éœ€è¦æª¢æŸ¥å…¶ä»– commits è®Šæ›´

### æœ€çµ‚çµè«–

**ç‚ºä»€éº¼ä»¥å‰æ²’æœ‰é€™å€‹å•é¡Œ?**
- **Phase 1-5**: åªç”¨å–®ä¸€ `subscribe()` èª¿ç”¨
- **Commit 7a4cc99 (12/20)**: å¼•å…¥ä¸‰å€‹è¨‚é–± + æ–°å›èª¿
- **çµæœ**: ç­–ç•¥åœ¨ pre_start() å´©æ½°,è¨‚é–±æœªåˆ°é” MD Gateway

**ASIO ææ§‹ vs connections: 0**:
- ASIO ææ§‹: æœå‹™åœæ­¢æ™‚å´©æ½° (å·²ä¿®å¾© âœ…)
- connections: 0: æœå‹™å•Ÿå‹•æ™‚å´©æ½° (å¾…ä¿®å¾© ğŸ”´)
- **å…©è€…ç¨ç«‹**: ä¿®å¾© ASIO ä¸æœƒè§£æ±º connections: 0

**æ‰¹åˆ¤æ€§æ€è€ƒåƒ¹å€¼**:
æˆåŠŸé¿å…äº†ã€Œç›²ç›®ä¿®å¾©ç†è«– bugã€â†’ã€Œå¿½è¦–å¯¦éš›å›æ­¸ bugã€çš„é™·é˜±

---

## ğŸ“‹ Phase 4 åŸ·è¡Œæ¸…å–®

### æ¸¬è©¦ 4.1: å›æ»¾åˆ°å–®ä¸€è¨‚é–± â¬œ
- [ ] å‚™ä»½ç•¶å‰ç­–ç•¥æ–‡ä»¶
- [ ] ä¿®æ”¹ `strategies/test_hf_live/test_hf_live.py` (åªä¿ç•™ `subscribe()`)
- [ ] é‡å•Ÿç­–ç•¥æœå‹™
- [ ] æª¢æŸ¥ `connections:` æ˜¯å¦æ¢å¾©ç‚º 3
- [ ] è¨˜éŒ„çµæœ

### æ¸¬è©¦ 4.2: æ¼¸é€²æ¸¬è©¦ â¬œ
- [ ] æ¸¬è©¦ Depth + Trade
- [ ] æ¸¬è©¦ Depth + Ticker
- [ ] æ¸¬è©¦å…¨éƒ¨ä¸‰å€‹
- [ ] ç¢ºå®šå…·é«”è¡çªé»

### æ¸¬è©¦ 4.3: å›èª¿éš”é›¢ â¬œ
- [ ] è¨»è§£ `on_trade()`, `on_ticker()`
- [ ] ä¿ç•™ä¸‰å€‹è¨‚é–±
- [ ] æ¸¬è©¦æ˜¯å¦æ¢å¾©

### Phase 5: å¯¦æ–½æœ€çµ‚ä¿®å¾© â¬œ
- [ ] æ ¹æ“šæ¸¬è©¦çµæœé¸æ“‡æ–¹æ¡ˆ
- [ ] ä¿®æ”¹ä»£ç¢¼
- [ ] å®Œæ•´å›æ­¸æ¸¬è©¦
- [ ] è¨˜éŒ„è§£æ±ºæ–¹æ¡ˆ

---

---

## ğŸ‰ æœ€çµ‚æ ¹æœ¬åŸå› ç¢ºèª (2025-12-23 15:30)

### âŒ å‡è¨­ 1: Commit 7a4cc99 å¤šè¨‚é–±å°è‡´å´©æ½°
**é©—è­‰çµæœ**: **éŒ¯èª¤** - Test 4.1 é¡¯ç¤ºå–®ä¸€è¨‚é–±ä¹Ÿæœƒå¤±æ•—

**æ¸¬è©¦éç¨‹**:
- ä¿®æ”¹ç­–ç•¥åªä¿ç•™å–®ä¸€ `subscribe()` èª¿ç”¨
- ç­–ç•¥ä»æ‹‹å‡º `RuntimeError: invalid md binance`
- PM2 é¡¯ç¤ºç­–ç•¥é‡å•Ÿ 35 æ¬¡

**çµè«–**: å•é¡Œä¸åœ¨è¨‚é–±æ•¸é‡

---

### âœ… æœ€çµ‚æ ¹æœ¬åŸå› : **å•Ÿå‹•æ™‚åºç«¶æ…‹**

#### å•é¡Œæè¿°
**ç­–ç•¥åœ¨ MD Gateway è¨»å†Šåˆ° Master ä¹‹å‰å°±å˜—è©¦è¨‚é–±,å°è‡´å´©æ½°**

#### è­‰æ“šéˆ

**è­‰æ“š 1: éŒ¯èª¤è¨Šæ¯**
```
[12/23 15:23:34.765] [warning] Unexpected exception before start
RuntimeError: invalid md binance
At: /app/strategies/test_hf_live/test_hf_live.py(43): pre_start
```

**è­‰æ“š 2: æ™‚åºåˆ†æ**
- ç­–ç•¥å•Ÿå‹•: 15:23:34.754
- MD Gateway æº–å‚™: 15:23:52.503 (**å»¶é² 18 ç§’**)
- ç­–ç•¥åœ¨ MD æº–å‚™å¥½ä¹‹å‰èª¿ç”¨ `context.add_marketdata("binance")`
- `context.cpp:200` æ‰¾ä¸åˆ°å·²è¨»å†Šçš„ MD â†’ æ‹‹å‡ºç•°å¸¸

**è­‰æ“š 3: PM2 é‡å•Ÿå¾ªç’°**
- ç­–ç•¥å´©æ½° â†’ PM2 è‡ªå‹•é‡å•Ÿ
- é‡å•Ÿå¾Œä»ç„¶å¤ªå¿« â†’ å†æ¬¡å´©æ½°
- é‡è¤‡ 35 æ¬¡,`connections: 0` æŒçºŒ

**è­‰æ“š 4: æ‰‹å‹•å»¶é²æ¸¬è©¦ (Test 4.2) âœ…**
```bash
# å…ˆåœæ­¢ç­–ç•¥
pm2 stop strategy_test_hf_live

# ç­‰å¾… MD Gateway å®Œå…¨ç©©å®š
sleep 10

# æ‰‹å‹•å•Ÿå‹•ç­–ç•¥
pm2 start strategy_test_hf_live
```

**çµæœ**:
- âœ… ç„¡éŒ¯èª¤,ç­–ç•¥æ­£å¸¸é‹è¡Œ
- âœ… `connections: 1` (å¾ 0 æ¢å¾©)
- âœ… Depth æ•¸æ“šæ­£å¸¸æµå…¥
- âœ… ç­–ç•¥æœå‹™ online,ç„¡é‡å•Ÿ

#### ç‚ºä»€éº¼ä»¥å‰æ²’å•é¡Œ?

**æ‰¹åˆ¤æ€§æ´å¯Ÿ**: å•é¡Œä¸€ç›´éƒ½å­˜åœ¨,ä½†ä¸æ˜¯ commit 7a4cc99 å¼•èµ·!

**å¯èƒ½åŸå› **:
1. **Phase 1-5** ä½¿ç”¨ä¸åŒå•Ÿå‹•è…³æœ¬,æœ‰éš±å¼å»¶é²
2. **ä¹‹å‰ç’°å¢ƒ**ç¡¬é«”æ›´å¿«,MD Gateway åˆå§‹åŒ–æ›´å¿«
3. **æ¸¬è©¦æ–¹å¼**ä¸åŒ,æ‰‹å‹•æ“ä½œç„¡æ„ä¸­é¿é–‹æ™‚åºå•é¡Œ
4. **PM2 é…ç½®**å¯èƒ½ä¹‹å‰æœ‰ `wait_ready` æˆ–ä¾è³´é…ç½®

#### æ™‚åºåœ–

```
æ™‚é–“è»¸:  0s    5s    10s   15s   20s   25s
         |     |     |     |     |     |
Master   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  (online)
Ledger        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  (online, 5s delay)
MD            â”€â”€â”€â”€â”€â”€â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  (online, 10s delay, è¨»å†Šéœ€ 8s)
Strategy      â–ˆâ”€â”€X  â–ˆâ”€â”€X  â–ˆâ”€â”€X  â–ˆâ”€â”€X  (å´©æ½°é‡å•Ÿå¾ªç’°)
              â†‘
              RuntimeError: invalid md binance
```

**æ­£ç¢ºæ™‚åº**:
```
æ™‚é–“è»¸:  0s    5s    10s   15s   20s   25s
         |     |     |     |     |     |
Master   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  (online)
Ledger        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  (online)
MD            â”€â”€â”€â”€â”€â”€â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  (online + è¨»å†Šå®Œæˆ)
Strategy                    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  (20s å¾Œå•Ÿå‹•,æˆåŠŸ)
```

---

## ğŸ“‹ ä¿®å¾©æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: ä¿®æ”¹ run.sh (æ¨è–¦ âœ…)

**æ–‡ä»¶**: `scripts/binance_test/run.sh`

**ä¿®æ”¹**: åœ¨å•Ÿå‹•ç­–ç•¥å‰æ·»åŠ ç­‰å¾…é‚è¼¯

```bash
start_strategy() {
    echo "Waiting for MD Gateway to be ready..."
    sleep 20  # æˆ–æª¢æŸ¥ MD Gateway ç‹€æ…‹

    pm2 start /app/runtime/strategy/test_hf_live/test_hf_live/live/test_hf_live.json
}
```

**å„ªé»**:
- ç°¡å–®ç›´æ¥,ç«‹å³ç”Ÿæ•ˆ
- ä¸ä¿®æ”¹ä»£ç¢¼é‚è¼¯
- é©ç”¨æ–¼æ‰€æœ‰ç­–ç•¥

**ç¼ºé»**:
- å›ºå®šå»¶é²ä¸å¤ å„ªé›…
- ä¸åŒç’°å¢ƒå¯èƒ½éœ€è¦ä¸åŒå»¶é²

### æ–¹æ¡ˆ B: ç­–ç•¥æ·»åŠ é‡è©¦æ©Ÿåˆ¶ (ç©©å¥ âœ…âœ…)

**æ–‡ä»¶**: `strategies/test_hf_live/test_hf_live.py`

**ä¿®æ”¹**: åœ¨ `pre_start()` æ·»åŠ é‡è©¦

```python
def pre_start(context):
    import time

    config = context.get_config()
    symbol = config["symbol"]
    md_source = config["md_source"]

    # ç­‰å¾… MD Gateway æº–å‚™å¥½ (æœ€å¤š 30 ç§’)
    for retry in range(30):
        try:
            context.subscribe(md_source, [symbol], InstrumentType.FFuture, Exchange.BINANCE)
            context.log().info(f"âœ… Subscribed: {symbol} (Futures) on retry {retry}")
            break
        except RuntimeError as e:
            if "invalid md" in str(e):
                context.log().warning(f"â³ MD Gateway not ready, retry {retry+1}/30...")
                time.sleep(1)
            else:
                raise
    else:
        raise RuntimeError(f"Failed to subscribe after 30 retries: MD Gateway '{md_source}' not available")
```

**å„ªé»**:
- è‡ªé©æ‡‰,ä¸éœ€è¦å›ºå®šå»¶é²
- ç­–ç•¥å…·æœ‰å®¹éŒ¯èƒ½åŠ›
- æ›´ç¬¦åˆç”Ÿç”¢ç’°å¢ƒéœ€æ±‚

**ç¼ºé»**:
- éœ€è¦ä¿®æ”¹æ¯å€‹ç­–ç•¥
- å¢åŠ ä»£ç¢¼è¤‡é›œåº¦

### æ–¹æ¡ˆ C: PM2 é…ç½® `wait_ready`

**æ–‡ä»¶**: PM2 é…ç½® JSON

**ä¿®æ”¹**: æ·»åŠ æœå‹™ä¾è³´

```json
{
  "apps": [
    {
      "name": "strategy_test_hf_live",
      "script": "python3",
      "args": "dev_run.py",
      "wait_ready": true,
      "listen_timeout": 30000
    }
  ]
}
```

**å„ªé»**:
- PM2 åŸç”Ÿæ”¯æŒ
- ä¸ä¿®æ”¹ä»£ç¢¼

**ç¼ºé»**:
- éœ€è¦ç­–ç•¥ç™¼é€ `ready` ä¿¡è™Ÿ
- é…ç½®è¤‡é›œ

---

## ğŸ“‹ Phase 4-5 åŸ·è¡Œçµæœ

### Test 4.1: å–®ä¸€è¨‚é–±å›æ»¾ âœ… å®Œæˆ
- [x] ä¿®æ”¹ç­–ç•¥åªä¿ç•™ `subscribe()`
- [x] é‡å•Ÿç­–ç•¥æœå‹™
- [x] çµæœ: **ä»ç„¶å¤±æ•—** (`RuntimeError: invalid md binance`)
- [x] **çµè«–**: å•é¡Œä¸åœ¨å¤šè¨‚é–±

### Test 4.2: æ‰‹å‹•å»¶é²å•Ÿå‹• âœ… å®Œæˆ
- [x] åœæ­¢ç­–ç•¥æœå‹™
- [x] ç­‰å¾… 10 ç§’ç¢ºä¿ MD Gateway ç©©å®š
- [x] æ‰‹å‹•å•Ÿå‹•ç­–ç•¥
- [x] çµæœ: **æˆåŠŸ** (`connections: 1`, Depth æ•¸æ“šæµå…¥)
- [x] **çµè«–**: ç¢ºèªæ˜¯æ™‚åºå•é¡Œ

### Test 4.3: æ¢å¾©å¤šè¨‚é–±æ¸¬è©¦ â¬œ å¾…åŸ·è¡Œ
- [ ] æ¢å¾© `subscribe()` + `subscribe_trade()` + `subscribe_ticker()`
- [ ] ä½¿ç”¨æ–¹æ¡ˆ B (é‡è©¦æ©Ÿåˆ¶) ç¢ºä¿æ™‚åº
- [ ] é©—è­‰ä¸‰å€‹è¨‚é–±éƒ½èƒ½æ­£å¸¸å·¥ä½œ
- [ ] ç¢ºèª `connections: 3` (Depth + Trade + Ticker)

---

## ğŸ“ å­¸ç¿’ç¸½çµ

### æ‰¹åˆ¤æ€§æ€è€ƒçš„å‹åˆ©

ç”¨æˆ¶æŒ‡ä»¤: **"be suspicious ç‚ºç”šéº¼ä»¥å‰æ²’æœ‰å‡ºç¾éé€™å€‹å•é¡Œ"**

**æ€è€ƒè·¯å¾‘**:
1. åˆæ­¥å‡è¨­: Commit 7a4cc99 å¤šè¨‚é–± â†’ âŒ éŒ¯èª¤
2. å›æ»¾æ¸¬è©¦: å–®ä¸€è¨‚é–±ä»å¤±æ•— â†’ æ’é™¤å¤šè¨‚é–±
3. è§€å¯Ÿæ—¥èªŒ: `RuntimeError: invalid md` â†’ æ™‚åºç·šç´¢
4. æ‰‹å‹•å»¶é²: æˆåŠŸæ¢å¾© â†’ âœ… ç¢ºèªæ™‚åºå•é¡Œ

**é—œéµæ´å¯Ÿ**:
- ä¸è¦ç›²ç›®ç›¸ä¿¡æœ€è¿‘çš„ä»£ç¢¼è®Šæ›´
- éŒ¯èª¤è¨Šæ¯æ¯”å‡è¨­æ›´å¯é  (`RuntimeError: invalid md`)
- å¯¦é©—é©—è­‰å‡è¨­ (Test 4.1 â†’ 4.2)
- æ‰¹åˆ¤æ€§æ€è€ƒé¿å…äº†éŒ¯èª¤çš„ä¿®å¾©æ–¹å‘

### ASIO ææ§‹ vs æ™‚åºå•é¡Œ

| å•é¡Œ | é¡å‹ | è§¸ç™¼æ™‚æ©Ÿ | ç‹€æ…‹ |
|------|------|---------|------|
| ASIO ææ§‹ | æŠ€è¡“å‚µ,RAII é•è¦ | æœå‹™**åœæ­¢æ™‚** | âœ… å·²ä¿®å¾© |
| å•Ÿå‹•æ™‚åº | æ¶æ§‹å•é¡Œ,ç«¶æ…‹æ¢ä»¶ | æœå‹™**å•Ÿå‹•æ™‚** | âœ… å·²å®šä½,å¾…ä¿®å¾© |

**å…©è€…ç¨ç«‹**: ä¿®å¾© ASIO ä¸æœƒè§£æ±ºæ™‚åºå•é¡Œ

---

**ä¸‹ä¸€æ­¥**:
1. å¯¦æ–½æ–¹æ¡ˆ B (ç­–ç•¥é‡è©¦æ©Ÿåˆ¶)
2. æ¢å¾©å¤šè¨‚é–±ä»£ç¢¼æ¸¬è©¦
3. é©—è­‰ `connections: 3` ä¸¦ç¢ºèªä¸‰ç¨®æ•¸æ“šé¡å‹éƒ½èƒ½æ­£å¸¸æ¥æ”¶
