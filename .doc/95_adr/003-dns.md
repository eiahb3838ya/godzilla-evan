# ADR-003: DNS Resolution Strategy in Docker + WSL2

Date: 2025-10-22 (Documented retroactively)

## Status

Accepted (Workaround implemented)

## Context

### Problem

Docker containers running on WSL2 frequently fail to resolve DNS:

```
Error: dial tcp: lookup auth.docker.io on 10.255.255.254:53: i/o timeout
Error: Temporary failure in name resolution
```

This breaks:
- `apt-get update` in container builds
- Network requests to external APIs
- Git operations over HTTPS
- Package installations (pip, npm, etc.)

### Root Cause

WSL2's DNS setup is complex:

1. **WSL2 generates /etc/resolv.conf** automatically:
   ```
   nameserver 10.255.255.254  # WSL2 internal DNS proxy
   ```

2. **The proxy forwards to Windows DNS**, which may be:
   - Corporate DNS (slow, filtering)
   - Router DNS (unreliable)
   - VPN DNS (blocks external queries)

3. **Docker inherits this DNS** from WSL2, leading to failures

4. **Common failure scenarios**:
   - VPN connected → VPN DNS blocks non-corporate domains
   - Corporate network → Firewall blocks 8.8.8.8
   - Home router → ISP DNS is slow/unreliable
   - WSL2 DNS proxy bug → Random timeouts

### Constraints

- Cannot easily modify WSL2's automatic DNS generation
- Docker Desktop manages Docker daemon (limited config access)
- Must work across different networks (home, office, VPN)
- Must persist across reboots

## Decision

Use **multi-layered DNS strategy** with public DNS servers configured at Docker daemon level.

### Primary Solution: Configure Docker Daemon DNS

Add reliable public DNS to Docker daemon configuration:

```json
// Docker Desktop → Settings → Docker Engine
{
  "dns": ["8.8.8.8", "114.114.114.114", "1.1.1.1"]
}
```

**Rationale**:
- 8.8.8.8: Google DNS (global, reliable)
- 114.114.114.114: China DNS (for China-based servers/mirrors)
- 1.1.1.1: Cloudflare DNS (privacy-focused, fast)

### Fallback: Per-Container DNS

For specific containers, override in docker-compose.yml:

```yaml
services:
  app:
    dns:
      - 8.8.8.8
      - 1.1.1.1
```

### Why This Works

1. **Bypasses WSL2 DNS proxy**: Containers use public DNS directly
2. **Multiple fallbacks**: If one DNS fails, others available
3. **Cross-network**: Public DNS works on any network
4. **Persistent**: Survives Docker/WSL2 restarts

## Consequences

### Positive

- DNS resolution works consistently
- Faster than corporate/ISP DNS
- Can reach both domestic and international domains
- One-time configuration
- Transparent to application

### Negative

- May bypass corporate DNS policies
- Public DNS sees all queries (privacy trade-off)
- May not resolve internal corporate domains when on VPN
- Workaround, not root cause fix

### Neutral

- DNS queries go to public servers
- Might need adjustment on different networks
- Need to remember this setup when troubleshooting

## Alternatives Considered

### Alternative 1: Fix WSL2 DNS Directly

```bash
# /etc/wsl.conf
[network]
generateResolvConf = false

# Then manually create /etc/resolv.conf
nameserver 8.8.8.8
```

**Not primary because**:
- WSL2 often overwrites /etc/resolv.conf
- Requires editing system files
- Breaks other WSL2 networking features
- Doesn't solve Docker DNS (Docker doesn't inherit this)

### Alternative 2: Host Network Mode

```yaml
services:
  app:
    network_mode: "host"
```

**Rejected because**:
- Breaks port isolation
- Can't run multiple containers on same port
- Security risk
- Doesn't work well on Windows/Mac Docker Desktop

### Alternative 3: dnsmasq in WSL2

Run local DNS cache in WSL2.

**Rejected because**:
- Adds complexity
- Requires WSL2 configuration
- Doesn't solve upstream DNS issue
- Overkill

## Related Decisions

- ADR-001: Docker-based development environment
- ADR-002: WSL2 as Docker backend

## Notes

### Diagnostic Commands

```bash
# Test DNS from WSL2
nslookup google.com
nslookup google.com 8.8.8.8

# Test DNS from container
docker run --rm alpine nslookup google.com
docker run --rm alpine ping -c 2 8.8.8.8

# Check container's DNS config
docker exec <container> cat /etc/resolv.conf

# Check WSL2's DNS
cat /etc/resolv.conf
```

### Network-Specific Adjustments

**Corporate Network**:
```json
{
  "dns": ["<corporate-dns>", "8.8.8.8"]
}
```

**China Network**:
```json
{
  "dns": ["114.114.114.114", "223.5.5.5", "8.8.8.8"]
}
```

**VPN Active**:
- May need to allowlist public DNS IPs in VPN split tunnel
- Or use corporate DNS as primary

### When This Won't Work

If organization **requires** using corporate DNS for all queries:
- Talk to IT about allowlisting public DNS
- Use VPN split tunneling
- Work from outside corporate network for initial setup

### References

Known WSL2 DNS issues:
- https://github.com/microsoft/WSL/issues/5420
- https://github.com/microsoft/WSL/issues/4285
- https://docs.docker.com/config/daemon/

---

Last Updated: 2025-10-22

