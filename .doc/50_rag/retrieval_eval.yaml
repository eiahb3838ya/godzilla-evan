---
title: RAG Retrieval Evaluation Suite
updated_at: 2025-11-17
owner: core-dev
lang: en
purpose: "Test queries with expected document matches to evaluate RAG retrieval quality"
---

# RAG Retrieval Evaluation Suite

## Purpose

This file contains test queries with expected document matches to evaluate RAG retrieval quality. Use this to measure precision, recall, and context sufficiency after implementing vector embeddings.

## Evaluation Metrics

- **Precision**: % of retrieved chunks that are relevant (in expected list)
- **Recall**: % of expected chunks that were retrieved (in top-K results)
- **MRR (Mean Reciprocal Rank)**: Average of 1/rank for first relevant result
- **Context Sufficiency**: % of queries answerable from retrieved context (human eval)

**Target Performance**:
- Precision: >80%
- Recall: >70%
- MRR: >0.85
- Context Sufficiency: >90%

## Test Queries

### Category: Strategy Development (10 queries)

#### Q1: Basic Strategy Setup
query: "How do I create a new trading strategy?"
expected_chunks:
  - 10_modules/strategy_framework.md#overview
  - 10_modules/strategy_framework.md#lifecycle-callbacks
  - 30_contracts/strategy_context_api.md#configuration--state
difficulty: easy
expected_rank_1: "10_modules/strategy_framework.md#overview"

#### Q2: Market Data Subscription
query: "How do I subscribe to order book data for BTCUSDT?"
expected_chunks:
  - 30_contracts/strategy_context_api.md#market-data-subscription
  - 30_contracts/depth_object_contract.md#usage-examples
  - 10_modules/strategy_framework.md#market-data-callbacks
difficulty: easy
expected_rank_1: "30_contracts/strategy_context_api.md#market-data-subscription"

#### Q3: Place Order
query: "How do I place a buy order in my strategy?"
expected_chunks:
  - 30_contracts/strategy_context_api.md#order-management
  - 30_contracts/order_object_contract.md#usage-examples
  - 10_modules/strategy_framework.md#order-callbacks
difficulty: easy
expected_rank_1: "30_contracts/strategy_context_api.md#order-management"

#### Q4: Order Status Tracking
query: "How do I track when my order gets filled?"
expected_chunks:
  - 10_modules/strategy_framework.md#order-callbacks
  - 30_contracts/order_object_contract.md#state-machine
  - 30_contracts/order_object_contract.md#order-status-lifecycle-example
difficulty: medium
expected_rank_1: "10_modules/strategy_framework.md#order-callbacks"

#### Q5: Cancel Order
query: "How do I cancel an open order?"
expected_chunks:
  - 30_contracts/strategy_context_api.md#order-management
  - 30_contracts/order_object_contract.md#state-machine
difficulty: easy
expected_rank_1: "30_contracts/strategy_context_api.md#order-management"

#### Q6: Access Order Book Levels
query: "How do I get the top 5 bid prices from the order book?"
expected_chunks:
  - 30_contracts/depth_object_contract.md#array-indexing
  - 30_contracts/depth_object_contract.md#usage-examples
  - 30_contracts/depth_object_contract.md#invariants
difficulty: medium
expected_rank_1: "30_contracts/depth_object_contract.md#array-indexing"

#### Q7: State Management
query: "How do I persist state between callbacks in my strategy?"
expected_chunks:
  - 30_contracts/strategy_context_api.md#configuration--state
  - 10_modules/strategy_framework.md#best-practices
difficulty: medium
expected_rank_1: "30_contracts/strategy_context_api.md#configuration--state"

#### Q8: Multiple Accounts
query: "Can I trade on multiple accounts from one strategy?"
expected_chunks:
  - 30_contracts/strategy_context_api.md#account-management
  - 10_modules/strategy_framework.md#architecture
difficulty: medium
expected_rank_1: "30_contracts/strategy_context_api.md#account-management"

#### Q9: Strategy Logging
query: "How do I add logging to my strategy?"
expected_chunks:
  - 30_contracts/strategy_context_api.md#logging
  - 10_modules/strategy_framework.md#best-practices
difficulty: easy
expected_rank_1: "30_contracts/strategy_context_api.md#logging"

#### Q10: Error Handling
query: "What happens if my order is rejected by the exchange?"
expected_chunks:
  - 30_contracts/order_object_contract.md#state-machine
  - 30_contracts/order_object_contract.md#error-transitions
  - 10_modules/strategy_framework.md#error-handling
difficulty: medium
expected_rank_1: "30_contracts/order_object_contract.md#error-transitions"

---

### Category: Configuration & Setup (8 queries)

#### Q11: Binance Testnet Setup
query: "How do I connect to Binance testnet?"
expected_chunks:
  - 30_contracts/binance_config_contract.md#testnet-configuration
  - 40_config/config_usage_map.md#endpoint-configuration
  - 30_contracts/binance_config_contract.md#usage-examples
difficulty: easy
expected_rank_1: "30_contracts/binance_config_contract.md#testnet-configuration"

#### Q12: Enable Futures Trading
query: "How do I enable Binance futures trading?"
expected_chunks:
  - 30_contracts/binance_config_contract.md#market-toggle-configuration
  - 40_config/config_usage_map.md#market-selection
difficulty: easy
expected_rank_1: "30_contracts/binance_config_contract.md#market-toggle-configuration"

#### Q13: API Key Setup
query: "Where do I put my Binance API keys?"
expected_chunks:
  - 30_contracts/binance_config_contract.md#structure
  - 30_contracts/binance_config_contract.md#security-warnings
  - 40_config/config_usage_map.md#credentials
difficulty: easy
expected_rank_1: "30_contracts/binance_config_contract.md#structure"

#### Q14: Production vs Testnet
query: "What's the difference between testnet and production endpoints?"
expected_chunks:
  - 30_contracts/binance_config_contract.md#endpoint-configuration
  - 40_config/config_usage_map.md#endpoint-configuration
difficulty: medium
expected_rank_1: "40_config/config_usage_map.md#endpoint-configuration"

#### Q15: Config File Location
query: "Where are configuration files stored?"
expected_chunks:
  - 40_config/config_usage_map.md#configuration-file-locations
  - 00_index/DESIGN.md#configuration-layer
difficulty: easy
expected_rank_1: "40_config/config_usage_map.md#configuration-file-locations"

#### Q16: Multiple Exchanges
query: "Can I connect to multiple exchanges at once?"
expected_chunks:
  - 10_modules/gateway_architecture.md#multi-exchange-support
  - 30_contracts/strategy_context_api.md#account-management
difficulty: medium
expected_rank_1: "10_modules/gateway_architecture.md#multi-exchange-support"

#### Q17: Reload Configuration
query: "How do I reload configuration without restarting?"
expected_chunks:
  - 30_contracts/strategy_context_api.md#configuration--state
  - 40_config/config_usage_map.md#runtime-updates
difficulty: medium
expected_rank_1: "30_contracts/strategy_context_api.md#configuration--state"

#### Q18: Credential Security
query: "How do I avoid committing my API keys to git?"
expected_chunks:
  - 30_contracts/binance_config_contract.md#security-warnings
  - 30_contracts/binance_config_contract.md#credential-protection-checklist
difficulty: easy
expected_rank_1: "30_contracts/binance_config_contract.md#security-warnings"

---

### Category: Data Structures (7 queries)

#### Q19: Order Object Fields
query: "What fields are in the Order object?"
expected_chunks:
  - 30_contracts/order_object_contract.md#structure-definition
  - 30_contracts/order_object_contract.md#fields
difficulty: easy
expected_rank_1: "30_contracts/order_object_contract.md#fields"

#### Q20: Order Status Values
query: "What are the possible order status values?"
expected_chunks:
  - 30_contracts/order_object_contract.md#orderstatus
  - 30_contracts/order_object_contract.md#state-machine
difficulty: easy
expected_rank_1: "30_contracts/order_object_contract.md#orderstatus"

#### Q21: Depth Array Indexing
query: "Is bid_price[0] the best bid or worst bid?"
expected_chunks:
  - 30_contracts/depth_object_contract.md#array-indexing
  - 30_contracts/depth_object_contract.md#common-pitfalls
difficulty: hard
expected_rank_1: "30_contracts/depth_object_contract.md#array-indexing"

#### Q22: Order Volume Calculation
query: "How do I calculate remaining order quantity?"
expected_chunks:
  - 30_contracts/order_object_contract.md#volume-relationships
  - 30_contracts/order_object_contract.md#fields
difficulty: medium
expected_rank_1: "30_contracts/order_object_contract.md#volume-relationships"

#### Q23: Exchange Order ID
query: "When is ex_order_id populated?"
expected_chunks:
  - 30_contracts/order_object_contract.md#id-assignment
  - 30_contracts/order_object_contract.md#order-status-lifecycle-example
difficulty: medium
expected_rank_1: "30_contracts/order_object_contract.md#id-assignment"

#### Q24: Depth Update Frequency
query: "How often does Binance send order book updates?"
expected_chunks:
  - 30_contracts/depth_object_contract.md#binance-spot
  - 30_contracts/depth_object_contract.md#performance-considerations
difficulty: medium
expected_rank_1: "30_contracts/depth_object_contract.md#binance-spot"

#### Q25: Sparse Order Book Levels
query: "What if the exchange has less than 10 price levels?"
expected_chunks:
  - 30_contracts/depth_object_contract.md#sparse-levels
  - 30_contracts/depth_object_contract.md#common-pitfalls
difficulty: medium
expected_rank_1: "30_contracts/depth_object_contract.md#sparse-levels"

---

### Category: System Architecture (8 queries)

#### Q26: Event-Driven Architecture
query: "How does the event system work?"
expected_chunks:
  - 10_modules/yijinjing_journal.md#architecture
  - 10_modules/strategy_framework.md#architecture
  - 20_interactions/event_flow.md#overview
difficulty: medium
expected_rank_1: "10_modules/yijinjing_journal.md#architecture"

#### Q27: Journal Storage
query: "Where is market data stored?"
expected_chunks:
  - 10_modules/yijinjing_journal.md#journal-storage
  - 10_modules/yijinjing_journal.md#performance-characteristics
difficulty: medium
expected_rank_1: "10_modules/yijinjing_journal.md#journal-storage"

#### Q28: Strategy Runtime
query: "How are strategies executed?"
expected_chunks:
  - 10_modules/strategy_framework.md#runtime
  - 10_modules/strategy_framework.md#lifecycle-callbacks
  - 20_interactions/strategy_lifecycle_flow.md#overview
difficulty: medium
expected_rank_1: "10_modules/strategy_framework.md#runtime"

#### Q29: Gateway Architecture
query: "How do exchange gateways work?"
expected_chunks:
  - 10_modules/gateway_architecture.md#overview
  - 10_modules/binance_extension.md#architecture
difficulty: medium
expected_rank_1: "10_modules/gateway_architecture.md#overview"

#### Q30: Market Data Flow
query: "How does market data reach my strategy?"
expected_chunks:
  - 20_interactions/market_data_flow.md#websocket-to-strategy
  - 10_modules/yijinjing_journal.md#message-passing
  - 30_contracts/depth_object_contract.md#latency-chain
difficulty: hard
expected_rank_1: "20_interactions/market_data_flow.md#websocket-to-strategy"

#### Q31: Order Lifecycle
query: "What happens after I call insert_order()?"
expected_chunks:
  - 20_interactions/order_lifecycle_flow.md#insert-to-acknowledgment
  - 30_contracts/order_object_contract.md#state-machine
  - 10_modules/gateway_architecture.md#order-routing
difficulty: hard
expected_rank_1: "20_interactions/order_lifecycle_flow.md#insert-to-acknowledgment"

#### Q32: Python/C++ Bindings
query: "How does Python strategy code call C++ functions?"
expected_chunks:
  - 10_modules/python_bindings.md#pybind11-architecture
  - 10_modules/python_bindings.md#binding-strategy-context
difficulty: hard
expected_rank_1: "10_modules/python_bindings.md#pybind11-architecture"

#### Q33: Position Management
query: "How are positions tracked?"
expected_chunks:
  - 10_modules/ledger_system.md#position-tracking
  - 10_modules/ledger_system.md#account-book-structure
difficulty: medium
expected_rank_1: "10_modules/ledger_system.md#position-tracking"

---

### Category: Operations & Debugging (7 queries)

#### Q34: Start System
query: "How do I start the trading system?"
expected_chunks:
  - 90_operations/pm2_startup_guide.md#starting-services
  - 90_operations/pm2_startup_guide.md#service-dependencies
difficulty: easy
expected_rank_1: "90_operations/pm2_startup_guide.md#starting-services"

#### Q35: View Logs
query: "Where are the log files?"
expected_chunks:
  - 90_operations/LOG_LOCATIONS.md#log-directory-structure
  - 90_operations/DEBUGGING.md#log-analysis
difficulty: easy
expected_rank_1: "90_operations/LOG_LOCATIONS.md#log-directory-structure"

#### Q36: Debug Market Data
query: "My strategy isn't receiving market data, how do I debug?"
expected_chunks:
  - 90_operations/DEBUGGING.md#market-data-issues
  - 10_modules/yijinjing_journal.md#debugging
  - 30_contracts/strategy_context_api.md#market-data-subscription
difficulty: medium
expected_rank_1: "90_operations/DEBUGGING.md#market-data-issues"

#### Q37: Debug Order Rejection
query: "My order was rejected, how do I see the error?"
expected_chunks:
  - 90_operations/DEBUGGING.md#order-issues
  - 30_contracts/order_object_contract.md#error-transitions
difficulty: medium
expected_rank_1: "90_operations/DEBUGGING.md#order-issues"

#### Q38: CLI Commands
query: "What CLI commands are available?"
expected_chunks:
  - 90_operations/cli_operations_guide.md#command-reference
  - 90_operations/cli_operations_guide.md#common-workflows
difficulty: easy
expected_rank_1: "90_operations/cli_operations_guide.md#command-reference"

#### Q39: Docker Deployment
query: "How do I run this in Docker?"
expected_chunks:
  - 95_adr/001-docker.md#implementation
  - 90_operations/pm2_startup_guide.md#docker-environment
difficulty: medium
expected_rank_1: "95_adr/001-docker.md#implementation"

#### Q40: Performance Issues
query: "My strategy is slow, how do I optimize it?"
expected_chunks:
  - 10_modules/strategy_framework.md#performance-considerations
  - 10_modules/yijinjing_journal.md#performance-characteristics
  - 30_contracts/depth_object_contract.md#performance-considerations
difficulty: hard
expected_rank_1: "10_modules/strategy_framework.md#performance-considerations"

---

## Evaluation Protocol

### Automated Evaluation

```python
import chromadb
from evaluate_rag import evaluate_queries

# Load test queries
queries = load_yaml("retrieval_eval.yaml")

# Run retrieval for each query
results = []
for query in queries:
    # Retrieve top-10 chunks
    retrieved = chroma_collection.query(
        query_texts=[query["query"]],
        n_results=10
    )

    # Calculate metrics
    expected_ids = set(query["expected_chunks"])
    retrieved_ids = set(retrieved["ids"][0])

    precision = len(expected_ids & retrieved_ids) / len(retrieved_ids)
    recall = len(expected_ids & retrieved_ids) / len(expected_ids)

    # Find rank of first expected chunk
    for i, chunk_id in enumerate(retrieved["ids"][0]):
        if chunk_id == query["expected_rank_1"]:
            reciprocal_rank = 1 / (i + 1)
            break
    else:
        reciprocal_rank = 0

    results.append({
        "query": query["query"],
        "precision": precision,
        "recall": recall,
        "reciprocal_rank": reciprocal_rank
    })

# Aggregate metrics
avg_precision = mean([r["precision"] for r in results])
avg_recall = mean([r["recall"] for r in results])
mrr = mean([r["reciprocal_rank"] for r in results])

print(f"Precision: {avg_precision:.2%}")
print(f"Recall: {avg_recall:.2%}")
print(f"MRR: {mrr:.3f}")
```

### Manual Evaluation (Context Sufficiency)

For each query, have a human evaluator:
1. Read only the retrieved chunks (top-5 + adjacent context)
2. Attempt to answer the query
3. Rate: "Answerable" / "Partial" / "Insufficient"

**Scoring**:
- Answerable: 1.0
- Partial: 0.5
- Insufficient: 0.0

**Target**: >90% answerable

### Failure Analysis

For queries with poor performance:
1. **Low Precision** (irrelevant chunks retrieved):
   - Check embedding quality (are semantically similar docs clustered?)
   - Review chunk boundaries (are chunks too small/large?)
   - Consider adding metadata filters (layer, tags)

2. **Low Recall** (expected chunks not retrieved):
   - Check if expected chunks actually contain relevant info
   - Review query phrasing (does it match document language?)
   - Consider synonym expansion or query rewriting

3. **Low MRR** (relevant chunks ranked low):
   - Review re-ranking strategy (add layer priority, recency)
   - Check if metadata boosts are configured correctly
   - Consider fine-tuning embedding model

## Versioning

- **2025-11-17**: Initial evaluation suite (40 queries)
- **Future**: Add queries as new documentation is created
