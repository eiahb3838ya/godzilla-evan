name: Documentation Validation

on:
  push:
    paths:
      - '.doc/**'
      - 'core/**/*.h'
      - 'core/**/*.cpp'
  pull_request:
    paths:
      - '.doc/**'
      - 'core/**/*.h'
      - 'core/**/*.cpp'

jobs:
  validate-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tiktoken

      - name: Verify code references
        run: |
          cd .doc/90_operations/scripts
          python verify_code_refs.py
        continue-on-error: false

      - name: Check markdown links
        run: |
          cd .doc/90_operations/scripts
          python check_links.py
        continue-on-error: false

      - name: Estimate tokens
        run: |
          cd .doc/90_operations/scripts
          python estimate_tokens.py
        continue-on-error: true

      - name: Check token budget
        run: |
          cd .doc/90_operations/scripts
          python estimate_tokens.py | tee /tmp/token_report.txt

          # Extract total auto-load tokens (would need to parse index.yaml)
          # For now, just report
          echo "Token budget check - see report above"
        continue-on-error: true

      - name: Validate YAML front-matter
        run: |
          cd .doc

          # Check that all .md files have YAML front-matter
          for file in $(find . -name "*.md" -not -path "./DOC.md"); do
            if ! head -1 "$file" | grep -q "^---$"; then
              echo "ERROR: Missing YAML front-matter in $file"
              exit 1
            fi
          done

          echo "All markdown files have valid YAML front-matter"
        continue-on-error: false

      - name: Check for broken cross-references
        run: |
          cd .doc

          # Check that referenced files exist
          grep -r "\[.*\](\.\./" . --include="*.md" | while read -r line; do
            file=$(echo "$line" | cut -d: -f1)
            ref=$(echo "$line" | grep -oP '\[.*?\]\(\K[^)]+' | head -1)

            if [ -n "$ref" ]; then
              # Resolve relative path
              dir=$(dirname "$file")
              target=$(realpath -m "$dir/$ref" 2>/dev/null || echo "")

              if [ -n "$target" ] && [ ! -f "$target" ]; then
                echo "WARNING: Broken reference in $file â†’ $ref"
              fi
            fi
          done
        continue-on-error: true

      - name: Generate documentation report
        if: always()
        run: |
          cd .doc

          echo "# Documentation Validation Report" > /tmp/docs_report.md
          echo "" >> /tmp/docs_report.md
          echo "## Statistics" >> /tmp/docs_report.md
          echo "" >> /tmp/docs_report.md
          echo "- Total markdown files: $(find . -name '*.md' | wc -l)" >> /tmp/docs_report.md
          echo "- Total code references: $(grep -r '`.*:[0-9]' . --include='*.md' | wc -l)" >> /tmp/docs_report.md
          echo "- Total cross-references: $(grep -r '\[.*\](.*\.md' . --include='*.md' | wc -l)" >> /tmp/docs_report.md
          echo "" >> /tmp/docs_report.md

          cat /tmp/docs_report.md

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: docs-validation-report
          path: /tmp/docs_report.md
          retention-days: 30
