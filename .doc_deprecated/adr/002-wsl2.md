# ADR-002: Use WSL2 as Docker Backend on Windows

Date: 2025-10-22 (Documented retroactively)

## Status

Accepted (Implemented)

## Context

Given the decision to use Docker (ADR-001), we need to choose how Docker runs on Windows. Docker on Windows has three possible backends:

1. **WSL2**: Docker engine runs in WSL2 Linux kernel
2. **Hyper-V**: Docker engine runs in Hyper-V VM
3. **Windows Containers**: Windows-based containers (not applicable - need Linux)

### Requirements

- Must run Linux containers (app targets Ubuntu)
- Good file I/O performance
- Compatible with Cursor/VSCode
- Stable and well-supported
- Minimal resource overhead

### Current Environment

- OS: Windows 11
- Docker Desktop: v28.5.1
- WSL2: Ubuntu 22.04.5 LTS

## Decision

Use **WSL2 as the Docker backend** with project files stored in WSL2 filesystem.

### Configuration

1. **Docker Desktop Settings**:
   - Enable "Use the WSL 2 based engine"
   - Enable WSL integration for Ubuntu distribution

2. **Project Location**:
   ```bash
   # ✓ Correct: WSL2 filesystem
   /home/huyifan/projects/godzilla-evan
   
   # ✗ Wrong: Windows filesystem
   /mnt/c/Users/huyifan/projects/godzilla-evan
   ```

3. **IDE Access**:
   - Cursor connects to WSL2 via "Remote - WSL" extension
   - Edit files as if native Linux
   - Docker commands run in WSL2 terminal

## Consequences

### Positive

- Near-native Linux I/O performance
- Resource efficient: ~1-2GB RAM vs 4GB for VM
- Fast startup: WSL2 starts in seconds
- Real Linux kernel, no compatibility issues
- Excellent VSCode/Cursor integration
- Full bash/zsh support
- Direct access to localhost from Windows

### Negative

- DNS resolution issues (see ADR-003)
- Accessing Windows files (/mnt/c) is slow
- Windows-only solution (doesn't help macOS developers)
- Occasional networking quirks, IP address changes

### Neutral

- Two filesystems to manage (Windows vs WSL2)
- Can access WSL2 files from Windows via `\\wsl$\Ubuntu`
- Need to backup WSL2 filesystem separately

## Alternatives Considered

### Alternative 1: Hyper-V Backend

Use Docker Desktop with Hyper-V backend.

**Rejected because**:
- Requires Hyper-V (conflicts with other virtualization)
- Slower than WSL2
- More resource intensive
- Microsoft deprecating in favor of WSL2
- WSL2 is recommended since Docker Desktop 3.0

### Alternative 2: Windows Filesystem + WSL2

Keep project in Windows filesystem, access via WSL2.

**Rejected because**:
- **10-50x slower I/O performance**
- Build times increase from 30s to 5-10 minutes
- File watching unreliable

Benchmark:
```bash
# Build in /mnt/c:  580 seconds
# Build in ~/projects: 32 seconds
```

Reference: https://docs.microsoft.com/en-us/windows/wsl/compare-versions

### Alternative 3: Native Docker on Linux

Dual-boot to Linux and use native Docker.

**Rejected because**:
- Requires rebooting to switch OS
- Can't use Windows tools simultaneously
- See ADR-001 for full rationale

## Related Decisions

- ADR-001: Docker-based development environment
- ADR-003: DNS resolution strategy

## Notes

### Performance Tips

**Always use WSL2 filesystem**:
```bash
# Check where you are:
pwd
# If /mnt/c/..., you're in WRONG place
# Move to ~/projects/
```

**Access from Windows**:
```
\\wsl$\Ubuntu\home\huyifan\projects\godzilla-evan
```

**Memory limit** (optional):
```
# %USERPROFILE%\.wslconfig
[wsl2]
memory=8GB
processors=4
```

### Backup Strategy

WSL2 filesystem is separate from Windows.

Backup using:
```bash
# Export WSL2 distribution
wsl --export Ubuntu D:\Backups\ubuntu.tar

# Import on another machine
wsl --import Ubuntu D:\WSL\Ubuntu D:\Backups\ubuntu.tar
```

Or use Git (recommended for code).

### Known Issues

**IP address changes**: WSL2 IP can change on restart
- Use localhost, not WSL2 IP
- Docker ports accessible via localhost:port

**Clock drift**: WSL2 clock can drift after sleep
```bash
# Resync clock
sudo hwclock -s
```

**Disk space**: WSL2 virtual disk grows but doesn't auto-shrink
```powershell
# Compact disk (PowerShell as Admin)
wsl --shutdown
Optimize-VHD -Path $env:LOCALAPPDATA\Packages\CanonicalGroupLimited.Ubuntu*\LocalState\ext4.vhdx -Mode Full
```

### References

- WSL2 Documentation: https://docs.microsoft.com/en-us/windows/wsl/
- Docker Desktop WSL2: https://docs.docker.com/desktop/windows/wsl/
- File System Performance: https://docs.microsoft.com/en-us/windows/wsl/compare-versions

---

Last Updated: 2025-10-22

